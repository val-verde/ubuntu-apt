#!/bin/bash

set -e

function get-auth-bearer-info() {
    BEARER_CREDS=$(curl -X POST 'https://api.box.com/oauth2/token' \
                            --header 'Content-Type: application/x-www-form-urlencoded' \
                            --data-urlencode "client_id=${CLIENT_ID}" \
                            --data-urlencode "client_secret=${CLIENT_SECRET}" \
                            --data-urlencode 'grant_type=client_credentials' \
                            --data-urlencode 'box_subject_type=enterprise' \
                            --data-urlencode "box_subject_id=${ENTERPRISE_ID}")
    ACCESS_TOKEN=$(echo ${BEARER_CREDS} | jq -r '.access_token')
    EXPIRY_TIME=$(echo ${BEARER_CREDS} | jq -r '.expires_in')
}

get-auth-bearer-info

function list-folder-contents() {
    LIMIT=${LIMIT:-1000}
    OFFSET=${OFFSET:-0}
    FILE_LIST=$(curl -X GET "https://api.box.com/2.0/folders/${FOLDER_ID}/items?limit=${LIMIT}&offset=${OFFSET}" \
                        -H 'Content-Type: application/json' \
                        -H "Authorization: Bearer ${ACCESS_TOKEN}")
    FILE_COUNT=$(echo ${FILE_LIST} | jq length)
    FILE_ENTRIES=$(echo ${FILE_LIST} | jq -r '.entries')
}

function get-all-deb-files() {
    FOLDER_ID=129384435209 list-folder-contents
}

function get-unsigned-deb-files() {
    FOLDER_ID=129384136434
    list-folder-contents

    for i in `seq 0 $(($FILE_COUNT - 1))`; do
        FILE_NAME=$(echo ${FILE_ENTRIES} | jq -r "[.[].name][$i]")
        FILE_ID=$(echo ${FILE_ENTRIES} | jq -r "[.[].id][$i]")
        curl -X GET "https://api.box.com/2.0/files/${FILE_ID}/content" \
                    -H "Authorization: Bearer ${ACCESS_TOKEN}" \
                    -L --output ${FILE_NAME}
    done
}


get-unsigned-deb-files
